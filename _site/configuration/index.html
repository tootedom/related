<!doctype html>
<!--[if IE 9]><html class="lt-ie10" lang="en" > <![endif]-->
<html class="no-js" lang="en" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
  
     
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <title>ES Connections</title>
    

    
    <meta name="description" content="The various ways of connecting the indexing and searching webapps to an Elasticsearch cluster"/>
    
    
    <meta name="author" content="Dominic Tootell" />
    <meta name="copyright" content="relate it (c) 2013-2014" />
    <link rel="shortcut icon" href="/favicon.ico" />

	<link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="/stylesheets/foundation.css" />
    <script src="/javascripts/vendor/modernizr.js"></script>
</head>


  <body>
    

<!-- Nav Bar -->

  <header class="inner">

	<nav>	  
	  <div class="row">	  	
	    <div class="large-12 columns">	      
	      <div class="nav-bar right" style="padding-top: 30px">
	       <ul class="button-group">
	         <li><a href='/index.html' class="radius small button">Home</a></li>	         
	         <li><a href='/indexing/index.html' class="radius small button">Indexing</a><br/></li>
	         <li><a href='/searching/index.html' class="radius small button">Searching</a><br/></li>							 
	         <li><a href='/configuration/index.html' class="radius small button">Configuration</a></li>
	         <li><a href='/blog/index.html' class="radius small button">Blog</a></li>
	         <li><a href='/downloads.html'  class="radius small button">Downloads</a></li>         
	        </ul>
	      </div>
	      <h1><a href='https://github.com/tootedom/related'><img src="/images/relateitlogo.png"></a></h1>
	      <hr />
	    </div>
	  </div>
	</nav>	
</header>


  <!-- End Nav -->

    <div class="off-canvas-wrap">
  <div class="inner-wrap">

<nav class="tab-bar show-for-small">
  <a class="left-off-canvas-toggle menu-icon">
    <span></span>
  </a>
</nav>

<aside class="left-off-canvas-menu">

  <div class="sidebar-offcanvas">
          <h5>Documentation:</h5>          
          <nav>
            <ul class="off-canvas-list">
              <li class="heading">Indexing</li>
              
              
                
              
              

 

	<li><a href="/indexing/indexing1" data-search>Overview</a></li>


 

	<li><a href="/indexing/indexing2" data-search>Dates</a></li>


 

	<li><a href="/indexing/indexing3" data-search>Document Format</a></li>


 

	<li><a href="/indexing/indexing4" data-search>Properties</a></li>


 

	<li><a href="/indexing/indexing5" data-search>Logging</a></li>


              <li class="divider"></li>
              <li class="heading">Searching</li>
              
              
                
              
              

 

	<li><a href="/searching/searching1" data-search>Overview</a></li>


 

	<li><a href="/searching/searching2" data-search>Filters</a></li>


 

	<li><a href="/searching/searching3" data-search>Logging</a></li>


 

	<li><a href="/searching/searching4" data-search>Indexes</a></li>


 

	<li><a href="/searching/searching5" data-search>Aliases</a></li>


              <li class="divider"></li>
              <li class="heading">Configuration</li>
              
              
                
              
              

 

	
	<li><a href="/configuration/configuration1" data-search class="active">ES Connections</a></li>
	


 

	
	<li><a href="/configuration/configuration2" data-search>ES Type Mapping</a></li>
	


 

	
	<li><a href="/configuration/configuration3" data-search>ES Configuration</a></li>
	


 

	
	<li><a href="/configuration/configuration4" data-search>Webapp JVM</a></li>
	


 

	
	<li><a href="/configuration/configuration5" data-search>App Config</a></li>
	


 

	
	<li><a href="/configuration/configuration6" data-search>Tomcat</a></li>
	


 

	
	<li><a href="/configuration/configuration7" data-search>Diagrams</a></li>
	


            </ul>
          </nav>
        </div> 

 
</aside>

<a class="exit-off-canvas" href="#"></a>



  <!-- Main Page Content and Sidebar -->
  <section role="main">
  <div class="row">

    
        <div class="large-3 medium-4 columns">
      <div class="hide-for-small">
        <div class="sidebar">
          <h5>Documentation:</h5>          
          <nav>
            <ul class="side-nav">
              <li class="heading">Indexing</li>
              
              
                
              
              

 

	<li><a href="/indexing/indexing1" data-search>Overview</a></li>


 

	<li><a href="/indexing/indexing2" data-search>Dates</a></li>


 

	<li><a href="/indexing/indexing3" data-search>Document Format</a></li>


 

	<li><a href="/indexing/indexing4" data-search>Properties</a></li>


 

	<li><a href="/indexing/indexing5" data-search>Logging</a></li>


              <li class="divider"></li>
              <li class="heading">Searching</li>
              
              
                
              
              

 

	<li><a href="/searching/searching1" data-search>Overview</a></li>


 

	<li><a href="/searching/searching2" data-search>Filters</a></li>


 

	<li><a href="/searching/searching3" data-search>Logging</a></li>


 

	<li><a href="/searching/searching4" data-search>Indexes</a></li>


 

	<li><a href="/searching/searching5" data-search>Aliases</a></li>


              <li class="divider"></li>
              <li class="heading">Configuration</li>
              
              
                
              
              

 

	
	<li><a href="/configuration/configuration1" data-search class="active">ES Connections</a></li>
	


 

	
	<li><a href="/configuration/configuration2" data-search>ES Type Mapping</a></li>
	


 

	
	<li><a href="/configuration/configuration3" data-search>ES Configuration</a></li>
	


 

	
	<li><a href="/configuration/configuration4" data-search>Webapp JVM</a></li>
	


 

	
	<li><a href="/configuration/configuration5" data-search>App Config</a></li>
	


 

	
	<li><a href="/configuration/configuration6" data-search>Tomcat</a></li>
	


 

	
	<li><a href="/configuration/configuration7" data-search>Diagrams</a></li>
	


            </ul>
          </nav>
        </div> 
      </div>
    </div>
    <!-- Main Blog Content -->
    <div class="large-9 medium-8 columns" role="content">

    
<div class="magellan-container" data-magellan-expedition="fixed" style="left: auto;">
      <dl class="sub-nav">        
        
        
         
        
          <dd data-magellan-arrival="1" class="active"><a href="/configuration/configuration1">ES Connections</a></dd>       
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="2" ><a href="/configuration/configuration2">ES Type Mapping</a></dd>
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="3" ><a href="/configuration/configuration3">ES Configuration</a></dd>
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="4" ><a href="/configuration/configuration4">Webapp JVM</a></dd>
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="5" ><a href="/configuration/configuration5">App Config</a></dd>
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="6" ><a href="/configuration/configuration6">Tomcat</a></dd>
        
        <li class="divider">|</li>
        
         
        
          <dd data-magellan-arrival="7" ><a href="/configuration/configuration7">Diagrams</a></dd>
        
        <li class="divider">|</li>
                
      </dl>
</div>      
<!-- This loops through the paginated posts -->

  <h1><a href="/configuration/configuration1">ES Connections</a></h1>
  <div class="content">
    <p>The related item data is stored in that of elasticsearch. The ability to find the frequently related items, for a given item, is provided by that of elasticsearch and its faceting.</p>

<p>The indexing and searching web applications use the elasticsearch java library.</p>

<p>The means by which the indexing and searching applications talk to elastic is by using the elasticsearch binary transport protocol. Meaning, the version of the client embedded within the web applications (indexing and searching), <em>MUST</em> match that of the elasticsearch server. Also, the version of JAVA on the client and the server <code>MUST</code> be the same.</p>

<pre><code>Current embedded elasticsearch version is: **1.0.0**</code></pre>

<p>By default both applications use the Transport protocol to connect to elasticsearch with sniffing enabled:</p>

<pre><code>client.transport.sniff : true</code></pre>

<p>(Sniffing means that you can specify only a couple of hosts, and the client will glen information on the rest of the cluster through those nodes).</p>

<p>The reason behind no support for HTTP endpoint (in versions 1.0.0 and 1.0.1) is just to focus on using the most performant client option, which is that of the transport client. HTTP support is <em>now</em> available in version 1.0.2+.</p>

<p>The HTTP support requires either extra configuration at your side (i.e. a load balancer) to load balance over your ES nodes, Or you can use in simple internal round robin implementation in the HTTP client support.</p>

<p>The default connection protocol is that of <code>transport</code>, but the it is relatively easy to use <em>http</em>; as shown below.</p>

<h3 id="elasticsearch_connection_configuration">Elasticsearch Connection Configuration</h3>

<p>The defaults for indexing and searching have been set based on a JVM the is running 1GB with 128m of PermGen (The specific configuration for these JVM Parameters can be found below).</p>

<p>At minimum the only configuration required is the connection details for your elasticsearch installation:</p>

<pre><code>related-item.elastic.search.transport.hosts=10.0.1.19:9300</code></pre>

<p>This can be a comma separated list of hosts:</p>

<pre><code>related-item.elastic.search.transport.hosts=10.0.1.19:9300,10.0.1.29:9300</code></pre>

<p>By default the application uses the TRANSPORT client to connect to elastic search. If you only specify one host, but you have 2 nodes in your elasticsearch cluster, the transport client is enabled by default to sniff (ask the node for information about other nodes in the cluster), and obtain a list of other nodes to connect to.</p>
<hr />
<h3 id="elasticsearch_http_connection_configuration">Elasticsearch HTTP Connection Configuration</h3>

<p>As of release 1.0.2+ an http client connection has been made available, <a href="https://github.com/tootedom/related/issues/2">Issue 2</a>. The http client connection means that you do not have to have ES client library, as that of the ES server. This means you can upgrade the server with less fear of breaking the client implementation.</p>

<p>The Http client library used is that of the <a href="https://github.com/AsyncHttpClient/async-http-client">AsyncHttpClient</a>. Even though the asynchronous features of this http client library have not been taken advantage of, the easy of use of the library made it a preferred choice over that of something like Apache’s Http Client.</p>

<p>To enable the HTTP client connection you need to specify the property:</p>

<pre><code>-Drelated-item.es.client.type=http</code></pre>

<p>With this enabled the indexing and searching web applications use the HTTP connection factory to talk to the ES server’s http endpoint. In order for the app to know what to talk to you specify the following property (by default it is <code>http://127.0.0.1:9200</code>):</p>

<pre><code>-Drelated-item.elastic.search.http.hosts=http://10.0.1.19:9200</code></pre>

<p>You can specify multiple hosts, by comma separating them:</p>

<pre><code>-Drelated-item.elastic.search.http.hosts=http://10.0.1.19:9200,http://10.0.1.29:9200,http://10.0.1.39:9200,http://10.0.1.49:9200</code></pre>

<p>The http client will round robin requests over the given number of endpoints* (<em>see below for round robin details</em>).</p>

<p>By default the HTTP client will run a background scheduling task that talks to each ES endpoint, checking for any newly added ES nodes. If a node has been added the HTTP client is notified of the new host, and it will be made available for round robin allocation of http requests. The background thread runs every 15 minutes hitting the following url:</p>

<pre><code>host:port/_nodes/http</code></pre>

<p>from the returned json it parses the http endpoint information building a list of available connections. It is that list that forms the new list of load balanced nodes.</p>

<p>This sniffing of available ES servers can be disabled with the following property:</p>

<pre><code>-Drelated-item.elastic.search.http.nodesniffing.enabled=false</code></pre>

<p>If you wish to descrease the frequency of which the sniffing takes place use the following property:</p>

<pre><code>-Drelated-item.elastic.search.http.nodesniffing.retry.interval=30</code></pre>

<p>The default unit is minutes. This can be changed with the property:</p>

<pre><code>-Drelated-item.elastic.search.http.nodesniffing.retry.interval.unit=secs|mins|hours|days</code></pre>
<hr />
<h4 id="elasticsearch_http_connection_round_robin">Elasticsearch HTTP Connection Round Robin</h4>

<p>The Http Client performs round robin load balancing of requests over the set of available ES http nodes. So for example given 2 hosts:</p>

<pre><code>-Drelated-item.elastic.search.http.hosts=http://10.0.1.19:9200,http://10.0.1.29:9200</code></pre>

<p>Each host will be sent an equal number of requests. The round robin load balancing implementation uses an array size to a power of 2, to loop over the array of available hosts. This means for a list of 3 hosts. The load is <em>NOT</em> spread evenly over the nodes. Given 3 hosts:</p>

<pre><code>-Drelated-item.elastic.search.http.hosts=http://10.0.1.19:9200,http://10.0.1.29:9200,http://10.0.1.39:9200</code></pre>

<p>The host list internally will be expanded to a power of 2 (i.e 4 available hosts for load balancing). The extra hosts are made up from the existing list of actual available. Which means that for 3 defined hosts. 1 host will get more traffic than then others. For example the repetition may something like the follwoing list, where <code>http://10.0.1.19:9200</code> is in the list twice.</p>

<pre><code>http://10.0.1.19:9200,http://10.0.1.29:9200,http://10.0.1.39:9200,http://10.0.1.19:9200</code></pre>
<hr />
<h4 id="http_connection_configuration">Http Connection configuration</h4>

<p>The following properties can be used to control the HTTP connections, such as the request and connection timeouts to the elasticsearch nodes.</p>
<table><thead><tr><th>Property</th><th>Use</th></tr></thead><tbody><tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.request.timeout.ms=5000</code></td><td style="text-align: left;">The max amount ot time the http request agaist the elastic search node can take</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.connect.timeout.ms=2000</code></td><td style="text-align: left;">The max amount of time the http request can take to connect to the elasticsearch node</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.no.of.retries=0</code></td><td style="text-align: left;">The number of retries to try against the elasticsearch node.</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.follow.redirects=false</code></td><td style="text-align: left;">If we should automatically follow redirects issued by elasticsearch</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.connection.pool.enabled=true</code></td><td style="text-align: left;">If keep alive connections should be made to the elasticsearch nodes</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.compression.enabled=true</code></td><td style="text-align: left;">Compressed responses from elasticsearch can be dealt with</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.request.timeout.ms=15000</code></td><td style="text-align: left;">The amount of time allowed for making the node request to the elasticsearch server.</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.connect.timeout.ms=5000</code></td><td style="text-align: left;">The amount of time allowed to establish a connection to the elasticsearch node to obtain the nodes it knows about</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.no.of.retries=0</code></td><td style="text-align: left;">The number of automatic retries the GET request for node information.</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.multisearch.endpoint=/_msearch</code></td><td style="text-align: left;">The searching endpoint</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.endpoint=/_nodes/http</code></td><td style="text-align: left;">The endpoint used for sniffing nodes added to the cluster</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.retry.interval=15</code></td><td style="text-align: left;">The amount of time between runs for sniffing the cluster for any newly added elasticsearch nodes</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.retry.interval.unit=mins</code></td><td style="text-align: left;">The duration (minutes) for which the interval applies: days,hours,mins,secs</td></tr>
<tr><td class="nowraptext" style="text-align: left;"><code>related-item.elastic.search.http.nodesniffing.enabled=true</code></td><td style="text-align: left;">If node sniffing is enabled or not.</td></tr>
</tbody></table>
  </div>


    <div class="pagination-centered">
      <ul class="pagination">
      
      
      
         
        
        <li class="current"><a href="/configuration/configuration1">1</a></li>
        
      
         
        
        <li><a href="/configuration/configuration2">2</a></li>
        
      
         
        
        <li><a href="/configuration/configuration3">3</a></li>
        
      
         
        
        <li><a href="/configuration/configuration4">4</a></li>
        
      
         
        
        <li><a href="/configuration/configuration5">5</a></li>
        
      
         
        
        <li><a href="/configuration/configuration6">6</a></li>
        
      
         
        
        <li><a href="/configuration/configuration7">7</a></li>
        
      
      </ul>
    </div>


<!--       <article>

        <h3><a href="#">Blog Post Title</a></h3>
        <h6>Written by <a href="#">John Smith</a> on August 12, 2012.</h6>

        <div class="row">
          <div class="large-6 columns">
            <p>Bacon ipsum dolor sit amet nulla ham qui sint exercitation eiusmod commodo, chuck duis velit. Aute in reprehenderit, dolore aliqua non est magna in labore pig pork biltong. Eiusmod swine spare ribs reprehenderit culpa.</p>
            <p>Boudin aliqua adipisicing rump corned beef. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>
          </div>
          <div class="large-6 columns">
            <img src="http://placehold.it/400x240&text=[img]" />
          </div>
        </div>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

      </article>

      <hr />

      <article>

        <h3><a href="#">Blog Post Title</a></h3>
        <h6>Written by <a href="#">John Smith</a> on August 12, 2012.</h6>

        <div class="row">
          <div class="large-6 columns">
            <p>Bacon ipsum dolor sit amet nulla ham qui sint exercitation eiusmod commodo, chuck duis velit. Aute in reprehenderit, dolore aliqua non est magna in labore pig pork biltong. Eiusmod swine spare ribs reprehenderit culpa.</p>
            <p>Boudin aliqua adipisicing rump corned beef. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>
          </div>
          <div class="large-6 columns">
            <img src="http://placehold.it/400x240&text=[img]" />
          </div>
        </div>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow. Nulla corned beef sunt ball tip, qui bresaola enim jowl. Capicola short ribs minim salami nulla nostrud pastrami.</p>

      </article> -->

    </div>

    <!-- End Main Content -->


    <!-- Sidebar -->

<!--     <aside class="large-3 columns">

      <h5>Categories</h5>
      <ul class="side-nav">
        <li><a href="#">News</a></li>
        <li><a href="#">Code</a></li>
        <li><a href="#">Design</a></li>
        <li><a href="#">Fun</a></li>
        <li><a href="#">Weasels</a></li>
      </ul>

      <div class="panel">
        <h5>Featured</h5>
        <p>Pork drumstick turkey fugiat. Tri-tip elit turducken pork chop in. Swine short ribs meatball irure bacon nulla pork belly cupidatat meatloaf cow.</p>
        <a href="#">Read More &rarr;</a>
      </div>

    </aside> -->

    <!-- End Sidebar -->
  </div>

  <!-- End Main Content and Sidebar -->


  <!-- Footer -->
  </div>
</div>
<footer class="row">
    <div class="large-12 columns">
      <hr />
      <div class="row">
        <div class="large-6 columns">
          <p class="copyright">&copy; relate it maintained by <a href="https://github.com/tootedom">tootedom</a></p>
        </div>
        <div class="large-6 columns">
          <ul class="inline-list right">
            <li><a href="https://github.com/tootedom/related"><i class="fa fa-github"></i> Relate it (Source)</a></li>
            <li><address><a href="mailto:dominic.tootell@relateit.io"><i class="fa fa-envelope"></i> Dominic Tootell</a></address></li>
            <li><a href="https://twitter.com/tootedom"><i class="fa fa-twitter"></i>@tootedom</a></li>
          </ul>
        </div>
      </div>
    </div>
</footer>
<script src="/javascripts/vendor/jquery.js"></script>
<script src="/javascripts/foundation/foundation.js"></script>
<script src="/javascripts/foundation/foundation.dropdown.js"></script>
<script src="/javascripts/foundation/foundation.magellan.js"></script>
<script src="/javascripts/foundation/foundation.offcanvas.js"></script>
<script>
      $(document).foundation({
        // specify the class used for active dropdowns
        active_class: 'open'
      });

      var doc = document.documentElement;
      doc.setAttribute('data-useragent', navigator.userAgent);
</script>

  <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-47714522-1");
            pageTracker._trackPageview();
            } catch(err) {}
</script>
  </section>
  </body>
</html>